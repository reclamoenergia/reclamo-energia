<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Documento pronto - ReclamoEnergia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TXF7GV201Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-TXF7GV201Z');
    gtag('event', 'preview_generated', {
      page_location: window.location.href,
      page_title: document.title
    });
  </script>
  <style>
    :root{--blue:#2F5FA7;--green:#2E8B57;--bg:#f4f6f8;--muted:#6b7280;}
    body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:#111827;}
    .wrap{max-width:920px;margin:0 auto;padding:28px 16px 60px;}
    .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.08);padding:22px;}
    h1{margin:0 0 8px;color:var(--blue);font-size:24px}
    p{margin:0 0 14px;color:var(--muted);line-height:1.45}
    .doc{
      background:#fff;border:1px solid #e5e7eb;border-radius:14px;
      padding:18px; line-height:1.55; font-size:15px; white-space:pre-wrap;
      user-select:none; -webkit-user-select:none; -ms-user-select:none;
    }
    .watermark{position:relative;}
    .watermark:before{
      content:"ANTEPRIMA";
      position:absolute; top:45%; left:50%;
      transform:translate(-50%,-50%) rotate(-20deg);
      font-size:64px; font-weight:900;
      color:rgba(47,95,167,0.10);
      pointer-events:none;
      white-space:nowrap;
    }
    .box{
      margin-top:16px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      border-radius:14px;
      padding:16px;
    }
    .priceRow{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .price{font-size:28px; font-weight:900; color:var(--green);}
    .btn{
      padding:12px 16px;border-radius:10px;border:1px solid var(--green);
      background:var(--green);color:#fff;font-weight:900;font-size:16px;text-decoration:none;cursor:pointer;
    }
    .btn:hover{opacity:.93}
    ul{margin:10px 0 0 18px;color:#111827}
    li{margin:6px 0}
    .small{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45}
    .back{display:inline-block;margin-top:14px;color:var(--blue);text-decoration:none;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Il tuo documento è pronto</h1>
      <p>Controlla il testo qui sotto. Potrai scaricare il PDF pronto per l’invio (email/PEC) dopo il pagamento.</p>

      <div class="doc watermark" id="doc"></div>

      <div class="box">
        <div class="priceRow">
          <div>
            <div style="font-weight:900;color:#111827;">Scarica il documento pronto per l’invio</div>
            <div class="small">PDF formattato + versione pronta per email/PEC + mini guida “cosa fare dopo”.</div>
          </div>
          <div style="text-align:right;">
            <div class="price">7€</div>
            <div style="font-size:13px;color:#6b7280;">Prezzo lancio</div>
            <a class="btn" href="https://buy.stripe.com/6oU5kw09S9g5bufbSU6wE01" target="_blank" rel="noopener">Scarica ora</a>
           
          </div>
        </div>

        <ul>
          <li>Documento formale redatto in modo professionale</li>
          <li>Utilizzabile come prova dell’avvenuta comunicazione</li>
          <li>PDF pronto per email o PEC</li>
          <li>Oggetto email già pronto per l’invio</li>
          <li>Mini guida su cosa fare se non ricevi risposta</li>
          <li>Nessun abbonamento o costi ricorrenti</li>
        </ul>

        <div class="small">
          Il servizio fornisce modelli standard di comunicazione e non costituisce consulenza legale.
          <br><br>
          <a href="chi-siamo.html" style="color:#2F5FA7;font-weight:700;text-decoration:none;">Chi siamo</a>
          &nbsp;|&nbsp;
          <a href="privacy.html" style="color:#2F5FA7;font-weight:700;text-decoration:none;">Privacy</a>
        </div>
      </div>

      <a class="back" href="azione.html">← Indietro</a>
    </div>
  </div>

<script>
  const p = new URLSearchParams(location.search);
  const type = p.get('type') || 'reclamo';
  const reason = p.get('reason') || 'importo';

  // Dati inseriti
  const data = {
    fornitura: p.get('fornitura') || 'Luce',
    fornitore: p.get('fornitore') || 'Fornitore',
    pecFornitore: p.get('pecFornitore') || '',
    altroCitta: p.get('altroCitta') || '',
    nome: p.get('nome') || '',
    email: p.get('email') || '',
    pec: p.get('pec') || '',
    indirizzo: p.get('indirizzo') || '',
    telefono: p.get('telefono') || '',
    numCliente: p.get('numCliente') || '',
    numFattura: p.get('numFattura') || '',
    dataFattura: p.get('dataFattura') || '',
    importo: p.get('importo') || '',
    indirizzoFornitura: p.get('indirizzoFornitura') || '',
    descrizione: p.get('descrizione') || ''
  };

  const L = (label, value) => value ? `${label}: ${value}\n` : '';
  const T = (value) => value ? `${value}\n` : '';

  // Riga PEC fornitore (solo se presente)
  const PEC_DEST = data.pecFornitore ? ` ${data.pecFornitore}\n` : '';

  const oggi = new Date();
  const dd = String(oggi.getDate()).padStart(2,'0');
  const mm = String(oggi.getMonth()+1).padStart(2,'0');
  const yyyy = oggi.getFullYear();
  const dataOggi = `${dd}/${mm}/${yyyy}`;

  const luogoData = `${data.altroCitta || 'Luogo'}, ${dataOggi}`;
  const headerBlock = `${T(data.nome)}${T(data.indirizzo)}${L('Email', data.email)}${L('PEC', data.pec)}${L('Telefono', data.telefono)}`;
  const recipientBlock = `Spett.le
${data.fornitore}
${type === 'reclamo' || type === 'contatore' ? 'Ufficio Reclami' : 'Ufficio Clienti'}
${PEC_DEST}`;
  const detailsBlock = [
    data.numCliente ? `Codice cliente: ${data.numCliente}` : '',
    data.numFattura ? `Fattura di riferimento: n. ${data.numFattura} del ${data.dataFattura || '___'}` : '',
    data.indirizzoFornitura ? `Punto di fornitura: ${data.indirizzoFornitura}` : ''
  ].filter(Boolean).join('\n');

  const composeLetter = (subject, opening, request, regulationRef) => `${headerBlock}

${recipientBlock}
Oggetto: ${subject}

${detailsBlock ? `${detailsBlock}\n\n` : ''}${opening}

${request}

${regulationRef}

Resto in attesa di un riscontro scritto.

Luogo e data: ${luogoData}

Firma
________________________
${data.nome}`.trim();

  let testo = "";

  if(type === "reclamo") {

    if(reason === "stimata") {
      testo = composeLetter(
        `Reclamo per lettura stimata non corretta – fattura n. ${data.numFattura}`,
        `Con riferimento alla fattura indicata, segnalo che gli importi risultano calcolati sulla base di letture stimate non coerenti con i consumi effettivi della fornitura di ${data.fornitura}.`,
        'Chiedo la verifica puntuale delle letture, la ricostruzione dei consumi reali e l’emissione di eventuale fattura rettificativa con storno degli importi non dovuti.',
        'La presente è formulata ai sensi della regolazione ARERA in materia di qualità commerciale (TIQV), con richiesta di riscontro entro i termini previsti.'
      );
    }

    else if(reason === "doppia") {
      testo = composeLetter(
        `Reclamo per possibile doppia fatturazione – fattura n. ${data.numFattura}`,
        `Con la presente segnalo una possibile doppia fatturazione relativa alla fornitura di ${data.fornitura}, con addebiti che paiono riferiti a periodi già fatturati.`,
        `Chiedo una verifica amministrativa completa e l’annullamento/storno degli importi non dovuti, con emissione di documento rettificativo.`,
        'La richiesta è presentata nel rispetto della disciplina ARERA sulla trasparenza e correttezza della fatturazione e dell’art. 33 del Codice di condotta commerciale.'
      );
    }

    else if(reason === "voci") {
      testo = composeLetter(
        `Reclamo per addebito di voci non previste – fattura n. ${data.numFattura}`,
        `Con riferimento alla fattura indicata, rilevo la presenza di voci di costo non previste dal contratto o non adeguatamente motivate in bolletta.`,
        'Chiedo il dettaglio analitico degli addebiti e, ove non dovuti, la rettifica immediata della fattura con relativo storno.',
        'La presente è inviata in coerenza con gli obblighi di trasparenza informativa previsti dalla regolazione ARERA e dal Codice del Consumo (D.Lgs. 206/2005).'
      );
    }

    else {
      // IMPORTO ANOMALO (default)
      testo = composeLetter(
        `Reclamo formale relativo alla fattura n. ${data.numFattura}`,
        `Con la presente formulo reclamo in merito alla fattura indicata, dell’importo di ${data.importo} €, in quanto significativamente superiore rispetto ai consumi medi storici della medesima utenza.`,
        'Chiedo la verifica tecnica e amministrativa degli importi fatturati e, in caso di incongruenze, la rettifica con eventuale ricalcolo e storno.',
        'Il presente reclamo è presentato ai sensi della regolazione ARERA sulla qualità commerciale della vendita (TIQV), con richiesta di risposta entro i termini applicabili.'
      );
    }
  }

  else if(type === "rateizzazione") {
    testo = composeLetter(
      `Richiesta di rateizzazione fattura n. ${data.numFattura}`,
      `Con riferimento alla fattura indicata, dell’importo complessivo di ${data.importo} €, chiedo la possibilità di definire un piano di rateizzazione del pagamento.`,
      'La richiesta è motivata da temporanea difficoltà economica; resto disponibile a concordare un piano sostenibile e conforme alle vostre procedure.',
      'Si chiede di valutare la presente istanza secondo quanto previsto dalle condizioni contrattuali e dalla disciplina ARERA applicabile in tema di rateizzazione dei corrispettivi di fornitura.'
    );
  }

  else if(type === "contatore") {
    testo = composeLetter(
      'Richiesta di verifica tecnica del misuratore',
      `Con la presente segnalo consumi anomali relativi alla fornitura di ${data.fornitura} e richiedo una verifica del corretto funzionamento del misuratore installato presso ${data.indirizzoFornitura}.`,
      'Chiedo di ricevere indicazioni sulle modalità operative, sui tempi di intervento e sugli eventuali oneri previsti in caso di verifica.',
      'La richiesta è formulata in conformità alla regolazione ARERA in materia di misura e qualità del servizio, con richiesta di riscontro scritto.'
    );
  }

  else if(type === "voltura") {
    testo = composeLetter(
      'Richiesta di voltura del contratto di fornitura',
      `Con la presente chiedo la voltura del contratto relativo alla fornitura di ${data.fornitura} presso l’immobile sito in ${data.indirizzoFornitura}.`,
      'Resto a disposizione per trasmettere la documentazione necessaria e completare la procedura nei tempi previsti.',
      'Si richiede gestione della pratica secondo la disciplina ARERA vigente e le condizioni economiche/contrattuali applicabili.'
    );
  }

  const docEl = document.getElementById('doc');
  docEl.textContent = testo;
  ['copy','cut','dragstart','selectstart','contextmenu'].forEach((evt) => {
    docEl.addEventListener(evt, (e) => e.preventDefault());
  });

  // Salva il documento per poterlo scaricare in PDF nella pagina successiva (success.html)
  try {
    const payload = {
      text: testo,
      createdAt: Date.now(),
      type: type,
      reason: reason || '',
      filename: `ReclamoEnergia_${type}_${dataOggi.replaceAll('/','-')}.pdf`
    };
    localStorage.setItem('reclamoenergia_last_doc', JSON.stringify(payload));
  } catch (e) {
    // Se localStorage non è disponibile, pazienza: l'utente potrà comunque visualizzare il testo in anteprima.
  }
</script>
</body>
</html>
