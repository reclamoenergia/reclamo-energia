<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Pagamento riuscito - ReclamoEnergia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TXF7GV201Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-TXF7GV201Z');
    gtag('event', 'purchase_completed', {
      value: 7,
      currency: 'EUR'
    });
  </script>
  <style>
    :root{--blue:#2F5FA7;--green:#2E8B57;--bg:#f4f6f8;--muted:#6b7280;}
    body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:#111827;}
    .wrap{max-width:720px;margin:0 auto;padding:28px 16px 60px;}
    .card{
        position: relative;     /* crea contesto e limita overlay */
        z-index: 1;             /* assicura che la card stia sopra */
        background:#fff;
        border-radius:14px;
        box-shadow:0 6px 18px rgba(0,0,0,.08);
        padding:22px;
        text-align:center;
      }

    h1{margin:0 0 10px;color:var(--green);font-size:26px}
    p{margin:0 0 14px;color:var(--muted);line-height:1.45}
    .btn{
      display:inline-block;padding:12px 16px;border-radius:10px;border:1px solid var(--blue);
      background:var(--blue);color:#fff;font-weight:900;font-size:16px;text-decoration:none;
    }
    .btn:hover{opacity:.93}
    .box{margin-top:16px;border:1px solid #e5e7eb;background:#f9fafb;border-radius:14px;padding:14px;text-align:left;}
    .box b{color:#111827}
    .pec-box{margin-top:18px;padding:14px;border:1px solid #d1d5db;border-radius:12px;background:#f8fafc;text-align:left}
    .pec-box h2{margin:0 0 8px;font-size:18px;color:#1f2937}
    .pec-box p{margin:0 0 10px;color:#4b5563}
    .pec-text{width:100%;min-height:220px;border:1px solid #cbd5e1;border-radius:8px;padding:10px;font-family:inherit;font-size:14px;line-height:1.45;box-sizing:border-box;background:#fff}
    .small{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.45}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Pagamento riuscito ✅</h1>
      <p>Grazie. Scarica il PDF e invialo via email o PEC al tuo fornitore.</p>

      <a class="btn" href="./">Torna alla homepage</a>

      <br><br>
      <p style="margin-top:14px;color:#374151;">
          Il tuo documento è stato generato correttamente. Puoi scaricarlo in formato PDF e inviarlo al fornitore.
        </p>

<button
  class="btn"
  type="button"
  style="background:#2E8B57;border-color:#2E8B57;cursor:pointer;position:relative;z-index:9999;"
  onclick="downloadPdf()">
  Scarica PDF
</button>
<div class="small" id="pdfMsg" style="margin-top:10px;"></div>

<div class="pec-box">
  <h2>Testo copia e incolla per la PEC</h2>
  <p>Copialo qui sotto e incollalo direttamente nel corpo della tua PEC.</p>
  <textarea id="pecText" class="pec-text" readonly>Caricamento del testo in corso...</textarea>
  <button class="btn" type="button" style="margin-top:10px;" onclick="copyPecText()">Copia testo PEC</button>
  <div class="small" id="copyMsg"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
function getStoredPayload(){
  try {
    const raw = localStorage.getItem('reclamoenergia_last_doc');
    return raw ? JSON.parse(raw) : null;
  } catch(e) {
    return null;
  }
}

function loadPecText(){
  const payload = getStoredPayload();
  const pecText = document.getElementById('pecText');
  if(!payload || !payload.text){
    pecText.value = 'Non trovo il testo del documento in questo browser. Torna alla pagina del documento e rigenera il testo.';
    return;
  }
  pecText.value = payload.text.trim();
}

function copyPecText(){
  const pecText = document.getElementById('pecText');
  const copyMsg = document.getElementById('copyMsg');
  pecText.select();
  pecText.setSelectionRange(0, 99999);
  document.execCommand('copy');
  copyMsg.textContent = 'Testo PEC copiato ✅';
}

function downloadPdf(){
  const msg = document.getElementById('pdfMsg');
  msg.textContent = '';

  const payload = getStoredPayload();

  if(!payload){
    msg.textContent = "Non trovo il documento in questo browser. Torna alla pagina del documento e riprova.";
    return;
  }

  const text = (payload.text || '').trim();
  if(!text){
    msg.textContent = "Documento vuoto. Torna alla pagina del documento e riprova.";
    return;
  }

  const filename = (payload.filename || 'ReclamoEnergia.pdf').replace(/[^\w\-\.]+/g, '_');

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();

  const margin = 56;
  const maxWidth = pageWidth - margin * 2;
  const lineGap = 17;

  const ensurePageSpace = (needed = lineGap) => {
    if (y + needed > pageHeight - margin) {
      doc.addPage();
      y = margin;
    }
  };

  doc.setFont("times", "normal");
  doc.setFontSize(12);
  doc.setTextColor(28, 31, 37);

  let y = margin;
  const lines = text.split("\n");

  let i = 0;
  while (i < lines.length && !lines[i].trim().startsWith("Spett.le")) {
    const row = lines[i].trim();
    if (row) {
      ensurePageSpace();
      doc.text(row, margin, y);
      y += lineGap;
    }
    i++;
  }

  const destStartY = margin + 58;
  const destLines = [];
  while (i < lines.length && !lines[i].trim().startsWith("Oggetto:")) {
    const row = lines[i].trim();
    if (row) destLines.push(row);
    i++;
  }

  doc.setFont("times", "bold");
  destLines.forEach((line, idx) => {
    doc.text(line, pageWidth - margin, destStartY + idx * lineGap, { align: "right" });
  });

  y = Math.max(y, destStartY + destLines.length * lineGap) + 24;

  if (i < lines.length && lines[i].trim().startsWith("Oggetto:")) {
    ensurePageSpace(22);
    doc.setFont("times", "bold");
    doc.setFontSize(13);
    doc.text(lines[i].trim(), margin, y);
    y += 18;
    doc.setDrawColor(210, 216, 225);
    doc.line(margin, y, pageWidth - margin, y);
    y += 18;
    doc.setFont("times", "normal");
    doc.setFontSize(12);
    i++;
  }

  for (; i < lines.length; i++) {
    const row = lines[i].trimEnd();
    if (!row) {
      y += 10;
      continue;
    }
    const wrapped = doc.splitTextToSize(row, maxWidth);
    ensurePageSpace(wrapped.length * lineGap);
    doc.text(wrapped, margin, y);
    y += wrapped.length * lineGap;
  }

  doc.save(filename);




  
  

  msg.textContent = "PDF scaricato ✅";
}

loadPecText();
</script>

  
</body>
</html>
